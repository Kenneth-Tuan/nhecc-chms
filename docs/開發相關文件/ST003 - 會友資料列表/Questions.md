# ST003 - 會友資料列表：待澄清問題

**Last Updated**: 2026-02-11  
**Status**: Pending Clarification

本文件记录在撰写 Technical Design 过程中需要进一步澄清的问题。

---

## ✅ 已確認的資訊

根據 2026-02-11 的討論，以下資訊已確認：

### 設計稿參考

- 參考路徑：`docs/設計稿/人員管理 - 列表/`

### 搜索功能

- ✅ 按下按鈕才搜索（非即時搜索）
- ✅ 取消搜索手機號碼末三碼功能

### Quick View Modal 內容

- ✅ 基本資訊（姓名、性別、年齡）
- ✅ 聯絡資訊（手機、Email、Line ID、地址）⚠️ 遮罩
- ✅ 緊急聯絡人 ⚠️ 遮罩
- ✅ 教會資訊（受洗狀態、牧區、小組）
- ✅ 修課紀錄（在 Modal 中的另一個 Tab 中顯示）
- ✅ 角色標籤

### Modal 操作按鈕

- ✅ 編輯按鈕（需要 `member:edit` 權限）
- ✅ 關閉按鈕
- ✅ "顯示所有敏感資料"按鈕（Optional 優化）

### 錯誤處理

- ✅ API 調用失敗：使用 Toast 提示
- ✅ 權限不足：不顯示非用戶權限外可操作的元件

### 技術整合

- ✅ 復用 ST001 的 `useMember` composable
- ✅ 復用 ST001 的 `MemberResponse` type（含 canReveal 元數據）
- ⚠️ 整合 ST002 的 `applyScopeFilter` 到 API 查詢：另外討論
- ✅ 前端需要檢查 `userContext.permissions['member:view']`

---

## 🎨 設計稿觀察（重要發現）

根據 `docs/設計稿/人員管理 - 列表/screen.png` 的分析，發現以下**與 ST003 Description 不一致**的地方：

### ⚠️ 重大差異 1：聯絡資訊顯示方式

**設計稿顯示**：

- 手機號碼：完整顯示（如 `0912-345-678`）
- Email：完整顯示（如 `peter.chen@example.com`）
- **沒有任何遮罩！**

**ST003 Description 說明**：

- AC 2.5：「Mobile: 一律顯示遮罩格式 (如 09**-\***-\*\*8)。列表頁不提供『點擊解鎖』功能」

**❓ 需要確認**：

1. 列表頁的聯絡資訊是否應該遮罩？

   - 選項 A：**完全不遮罩**（設計稿方案，可能有資安疑慮）
   - 選項 B：**遮罩顯示**（符合 ST002 的 Privacy by Default 原則）
   - 選項 C：**根據使用者權限動態決定**（有 `revealAuthority.mobile` 權限者顯示明碼，否則遮罩）

2. 若採用選項 C，是否需要在列表中顯示「眼睛 icon」解鎖？
   - ST003 Description 說：「列表頁不提供『點擊解鎖』功能」
   - 但設計稿顯示完整號碼，暗示可能不需要遮罩？

**建議**：選項 C（根據權限動態決定），符合 RBAC 精神

選 B，按照 ST002，設計稿僅為參考。

---

### ⚠️ 重大差異 2：欄位定義

**設計稿欄位**（由左至右）：

1. 姓名/暱稱（Avatar + 中文名 + 英文名）
2. 聯絡資訊（手機 + Email）
3. 身份標籤（如：`已受洗`、`小組長`、`幹部`）
4. 歸屬小組（如：`大都組`）
5. 系統權限（如：`啟用友`、`管理員`）
6. 操作（編輯、刪除 icon）

**ST003 Description 欄位**：

1. Avatar（頭像）
2. Name（姓名）
3. Gender（性別，使用 Icon）
4. Age（年齡，系統計算）
5. Group（所屬小組）
6. Mobile（手機號碼，遮罩）
7. Status Badge（會籍狀態）
8. Action Column（操作按鈕）

**❓ 差異點**：

- 設計稿沒有顯示「性別」欄位
- 設計稿沒有顯示「年齡」欄位
- 設計稿有「身份標籤」欄位（顯示受洗狀態 + 角色）
- 設計稿有「系統權限」欄位（顯示會籍狀態？）
- 設計稿顯示「英文暱稱」（Member Schema 中沒有此欄位）

**需要確認**：

1. 是否以設計稿為準？
2. 若是，Member Schema 是否需要新增 `nickname` (英文暱稱) 欄位？
3. 「系統權限」欄位的定義？（是指 Status? 還是 Role?）

**建議**：與設計師確認設計稿是否為最新版本

以 Description 為主，設計稿僅參考。
另外，請參考 ST001 & ST002 中所提到的 Member 欄位來更新這裡所需要的欄位

---

### ⚠️ 重大差異 3：搜索欄位

**設計稿 Placeholder**：「搜尋、暱稱或 Email...」

**ST003 Description**：「支援欄位：full_name (模糊搜尋)、mobile」

**❓ 需要確認**：

- 是否支援 Email 搜索？（設計稿有提到）
- 「暱稱」是指什麼？（英文名？Line ID？）
- 最終搜索欄位清單？

目前先只支援 full_name 搜尋

---

### ⚠️ 重大差異 4：篩選選項

**設計稿篩選器**：

1. 所有角色（下拉選單）
2. 受洗狀態（下拉選單）
3. 歸屬小組（下拉選單）

**ST003 Description 篩選器**：

1. Status（Active / Inactive）
2. Group（僅 Scope >= Zone 提供）

**❓ 需要確認**：

1. 「所有角色」篩選器的用途？（篩選會友的 Role?）
2. 是否需要「受洗狀態」篩選？（設計稿有，但 Description 沒提）
3. 是否需要「Status」篩選？（Description 有，但設計稿沒提）

**建議**：與 PO 確認最終的篩選器清單

Status 篩選要有
受洗狀態篩選要有
根據當前使用者的角色來決定是否可以進行跨 zone 搜尋，如果角色的權限範圍 >= zone，即介面上支援按小組搜尋；如果 >= Globl，可變為聯級搜尋，即 zone -> group，本質上還是按小組搜尋，只是範圍變為全教會

---

### 📊 設計稿其他觀察

1. **分頁方式**：數字分頁（1 2 3 ... 125），支援跳頁
2. **總筆數顯示**：「顯示 1-10 筆，共 1,250 筆資料」
3. **操作按鈕**：僅有編輯（鉛筆）和刪除（垃圾桶）icon，沒有「查看詳情」按鈕
4. **側邊欄**：顯示使用者頭像、姓名、角色（王大明 / 系統管理員）

**❓ 需要確認**：

- 若沒有「查看詳情」按鈕，如何觸發 Quick View Modal？
  - 選項 A：點擊整行（Row click）
  - 選項 B：點擊姓名
  - 選項 C：新增獨立的「查看」icon

**建議**：選項 A（點擊整行），UX 較直觀

選 A

---

## ❓ 待確認問題

### 1. 列表欄位顯示細節

#### 1.1 年齡 (Age) 欄位

**問題**：年齡的計算與顯示方式？

**選項**：

- A) 顯示足歲（如：34 歲）
- B) 顯示出生年份（如：1990 年生）
- C) 兩者都顯示（如：34 歲 (1990)）

**建議**：選項 A（顯示足歲，計算方式：`Math.floor((today - dob) / 365.25)`）

選 A

---

#### 1.2 角色標籤 (Role Tags) 顯示

**問題**：當會友擁有多個角色時，列表中如何顯示？

**選項**：

- A) 顯示所有角色（如：`<Tag>小組長</Tag> <Tag>課程老師</Tag>`）
- B) 只顯示最高權限角色（如：只顯示 `小組長`）
- C) 顯示主要角色 + 數量提示（如：`小組長 +2`）
- D) 不在列表中顯示角色，僅在 Modal 中顯示

**影響**：會影響列表的欄位寬度與資訊密度

**建議**：選項 D（列表簡潔，詳細資訊在 Modal）

選 C，hover 時用 tooltop 顯示完整的角色，元件請使用 primevue 中的元件，不要另外開發

---

#### 1.3 小組欄位顯示

**問題**：當會友未分配小組時，顯示什麼？

**已知**：ST003 Description 提到 "若為 Pending 則顯示 '待分發'"

**需確認**：

- 「待分發」的 UI 樣式？（灰色 Tag? 橘色 Badge?）
- 點擊「待分發」是否有任何操作？（如：快速分配到小組）

樣式就跟其他 row 中，有小分配到小組時所呈現的是一樣的，但是背景色顯示橘色，文字寫帶分發。點擊後會導向組織架構管理的路由。

---

### 2. Quick View Modal 設計細節

#### 2.1 Modal Tab 結構

**問題**：Modal 應該有幾個 Tab？每個 Tab 的內容？

**建議結構**：

```
Tab 1: 基本資料
  - 左側：大頭貼、角色標籤、帳號狀態
  - 右側：
    - Section 1: 基本資訊（姓名、性別、年齡、生日）
    - Section 2: 聯絡資訊（手機、Email、Line ID、地址）⚠️ 遮罩
    - Section 3: 緊急聯絡人 ⚠️ 遮罩
    - Section 4: 教會資訊（受洗狀態、受洗日期、牧區、小組）

Tab 2: 修課紀錄
  - 已完成課程列表（課程名稱、完成日期、成績）
  - 進行中課程列表
  - 空白狀態提示（若無修課紀錄）

（未來可擴充）
Tab 3: 聚會紀錄 (ST023)
Tab 4: 牧養筆記 (ST024)
```

**需確認**：

- 是否符合設計稿？
- Tab 2 的修課紀錄要顯示哪些欄位？

這部分目前沒有設計稿，我們自行設計。
用 table 來顯示，欄位：課程名稱、完成日期、課程狀態
完成的課程就會顯示：XXX 課程、2026-02-11、畢業
未通過的課程就會顯示：YYY 課程、2026-02-11、未通過
進行中的課程就會顯示：ZZZ 課程、-、進行中

---

#### 2.2 "顯示所有敏感資料"按鈕行為

**問題**：點擊後的具體行為與狀態管理？

**待確認**：

1. **按鈕位置**：

   - 在 Modal Header？
   - 在敏感資訊 Section 的標題旁？

2. **解鎖行為**：

   - 點擊後一次性呼叫 API 取得所有敏感欄位明碼？
   - 還是逐一呼叫每個欄位的 reveal API？

3. **確認機制**：

   - 是否需要二次確認？（如：顯示 Confirm Dialog）
   - 確認文案：「您確定要查看所有敏感資料嗎？此操作將被記錄。」

4. **狀態持續**：

   - 解鎖後關閉 Modal，重新開啟時需要重新解鎖？
   - 還是在整個 Session 中保持解鎖狀態？

5. **Audit Log**：
   - 一次性解鎖應記錄為一筆 Log 還是多筆？
   - Log 訊息格式？

**建議**：

- 位置：敏感資訊 Section 的標題旁
- 行為：一次性呼叫 API（`POST /api/members/:id/reveal/all`）
- 確認：需要二次確認
- 持續：僅在該 Modal 開啟期間，關閉後重置
- Log：記錄為一筆 Log，包含所有解鎖的欄位清單

按照建議來，但 api 改成傳入 array，瀏覽單個敏感資料時就是傳入單個欄位名稱，array 中只有一個值；一次瀏覽全部敏感資料就是把所有敏感資料欄位名稱加入到 array，共用同一隻 api

---

### 3. 搜索功能規格

#### 3.1 搜索欄位範圍

**問題**：搜索支援哪些欄位？

**已知**：ST003 Description 提到 "full_name (模糊搜尋)、mobile (支援搜尋末三碼或完整號碼)"

**更新**：已取消末三碼搜索

**待確認**：

- 搜索欄位：`full_name`, `mobile`（完整號碼）, `email`?
- 是否支援 Email 搜索？
- 是否支援 Line ID 搜索？

**建議**：僅支援 `full_name` 和 `mobile`（完整號碼），避免過於複雜

按照建議來

---

#### 3.2 搜索匹配規則

**問題**：搜索是模糊搜索還是精確匹配？

**待確認**：

- 姓名搜索：模糊搜索（包含關鍵字即可）
- 手機搜索：精確匹配（完全符合才顯示）or 模糊搜索？

**技術限制**：Firestore 不支援 LIKE 查詢，需要：

- 前端過濾（適用於 Scope 較小的情況，如 Group Leader）
- Algolia/ElasticSearch（未來考慮）

**建議**：

- 姓名：前端模糊搜索（載入該 Scope 的所有會友，前端過濾）
- 手機：後端精確匹配（Firestore `where('mobile', '==', searchTerm)`）

按照建議來開發

---

#### 3.3 搜索結果提示

**問題**：搜索後的 UI 反饋？

**待確認**：

- 是否顯示「搜索結果：找到 5 筆符合『王』的資料」？
- 搜索關鍵字是否高亮顯示？
- 清除搜索的按鈕位置？

- 是
- 是
- 清除按鈕在搜索按鈕旁邊

---

### 4. 進階篩選 (Advanced Filter)

#### 4.1 Status 篩選選項

**問題**：Status 篩選包含哪些選項？

**已知**：Member Schema 中 `status` 欄位有三種狀態：

- `Active`（啟用）
- `Inactive`（停用）
- `Suspended`（暫停）

**待確認**：

- 是否需要全部顯示？（All / Active / Inactive / Suspended）
- 還是只顯示 Active / Inactive（隱藏 Suspended）？

**預設值**：是否預設只顯示 `Active` 會友？

**建議**：預設顯示 `Active`，篩選選項包含：

- 全部
- 啟用 (Active)
- 停用 (Inactive)

按照建議

---

#### 4.2 Group 篩選的 Cascade 邏輯

**問題**：當篩選 Zone 時，Group 下拉選單是否自動更新？

**已知**：ST001 已實作 `useZoneGroup` composable 支援 Cascade

**待確認**：

- 當選擇 Zone 後，Group 選項是否自動篩選為該 Zone 下的小組？
- 清除 Zone 篩選時，Group 篩選是否自動清除？

**建議**：是，參考 ST001 的 Member Form 實作

按照建議

---

#### 4.3 「待分發」篩選

**問題**：是否需要專門的「待分發」篩選選項？

**場景**：方便 Zone Leader 快速找到尚未分配小組的會友

**選項**：

- A) 在 Group 篩選中加入「待分發」選項
- B) 單獨的「僅顯示待分發」Checkbox
- C) 不提供，靠搜索條件組合（Zone + Group 為 null）

**建議**：選項 A（在 Group 下拉選單加入「待分發」選項）

按照建議

---

### 5. 排序功能

#### 5.1 可排序欄位

**問題**：除了預設的 `created_at`，是否支援其他欄位排序？

**已知**：ST003 Description 提到 "支援點擊表頭依 Age 或 Name 進行排序"

**待確認**：

- Age 排序：依出生日期升序/降序
- Name 排序：依中文姓名筆劃？拼音？

**技術考量**：

- Firestore 排序需要建立 Composite Index
- 中文排序可能需要前端處理

**建議**：

- Name 排序：依 Unicode 排序（前端處理）
- Age 排序：依 `dob` 欄位（後端 Firestore 排序）

先只做 Age 排序

---

#### 5.2 排序 UI 設計

**問題**：排序的視覺反饋？

**待確認**：

- 是否顯示升序/降序 icon？（▲ / ▼）
- 當前排序欄位是否高亮顯示？

要顯示，參考 primevue dataTable https://primevue.org/llms/components/datatable.md

---

### 6. 分頁功能

#### 6.1 每頁筆數

**問題**：是否允許使用者調整每頁顯示筆數？

**已知**：預設每頁 20 筆

**待確認**：

- 是否提供「每頁顯示」下拉選單？（10 / 20 / 50 / 100）
- 還是固定 20 筆？

**建議**：固定 20 筆（簡化 UI）

提供 每頁顯示 下拉選單（10 / 20 / 50 / 100）

---

#### 6.2 分頁 UI 樣式

**問題**：使用 PrimeVue 的哪種分頁樣式？

**選項**：

- A) 數字分頁（1 2 3 ... 10）
- B) 上一頁/下一頁按鈕
- C) 兩者結合

**建議**：選項 C（參考 PrimeVue DataTable 預設樣式）

按建議

---

### 7. 權限控制細節

#### 7.1 操作按鈕的顯示邏輯

**問題**：當使用者沒有權限時，如何處理操作按鈕？

**已確認**：不顯示非用戶權限外可操作的元件

**待確認**：

- 「查看詳情」按鈕：所有人都可見？還是需要 `member:view` 權限？
- 「編輯」按鈕：完全隱藏？還是顯示但 disabled + Tooltip 提示「無權限」？

**建議**：

- 「查看詳情」：需要 `member:view` 權限
- 「編輯」、「刪除」：完全隱藏（不顯示）

按照建議

---

#### 7.2 Scope 過濾的前端檢查

**問題**：前端是否需要檢查 Scope？

**已確認**：前端需要檢查 `userContext.permissions['member:view']`

**待確認**：

- 若使用者無 `member:view` 權限，是否直接跳轉至首頁？
- 還是顯示「無權限」提示頁面？

**建議**：顯示「無權限」提示頁面，避免突然跳轉造成困惑

按照建議

---

### 8. 響應式設計

#### 8.1 移動端顯示

**問題**：列表在移動端的顯示方式？

**選項**：

- A) 卡片式列表（每個會友一張卡片）
- B) 簡化版表格（隱藏部分欄位）
- C) 不支援移動端（僅桌面版）

**建議**：選項 B（隱藏部分欄位，保留姓名、小組、操作按鈕）

按照建議

---

#### 8.2 Modal 在小螢幕的行為

**問題**：Quick View Modal 在手機上的顯示方式？

**選項**：

- A) 全螢幕 Modal
- B) 下方滑出 (Bottom Sheet)
- C) 縮小版 Modal

**建議**：選項 A（全螢幕 Modal，方便操作）

選 B

---

### 9. 效能考量

#### 9.1 虛擬滾動

**問題**：列表是否需要虛擬滾動？

**場景**：當會友數量很大時（如：超過 1000 人）

**待確認**：

- 系統預期的會友數量級？（100 / 1000 / 10000）
- 是否使用 Server-side Pagination 已足夠？

**建議**：使用 Server-side Pagination 即可，暫不需要虛擬滾動

按照建議

---

#### 9.2 前端快取策略

**問題**：列表資料是否需要前端快取？

**場景**：使用者切換頁面後返回，避免重新載入

**選項**：

- A) 使用 Pinia 快取（5 分鐘 TTL）
- B) 不快取，每次進入都重新載入
- C) 使用瀏覽器 sessionStorage

**建議**：選項 A（使用 Pinia，提升 UX）

按照建議

---

### 10. Empty State & Loading State

#### 10.1 空狀態提示

**問題**：當列表無資料時的提示？

**場景**：

- 首次進入系統，尚無會友資料
- 搜索無結果
- 篩選條件過嚴，無符合資料

**待確認**：

- 提示文案？
- 是否提供「新增會友」按鈕？（需 `member:create` 權限）

**建議文案**：

- 無會友資料：「目前尚無會友資料，請點擊右上角『新增會友』按鈕開始建立。」
- 搜索無結果：「找不到符合『{keyword}』的資料，請嘗試其他關鍵字。」
- 篩選無結果：「目前沒有符合篩選條件的會友。」

按照建議

---

#### 10.2 Loading State

**問題**：載入中的 UI 顯示？

**選項**：

- A) 全頁 Skeleton Screen
- B) 表格內 Loading Spinner
- C) 頂部 Progress Bar

**建議**：選項 B（表格內顯示 PrimeVue DataTable 的 `loading` 狀態）

按照建議

---

### 11. 錯誤處理

#### 11.1 網路斷線處理

**問題**：當網路斷線時的行為？

**待確認**：

- 是否顯示「網路連線異常」提示？
- 是否提供「重試」按鈕？
- 是否使用 Offline Mode（顯示快取資料）？

**建議**：顯示 Toast 提示 + 重試按鈕

按照建議

---

#### 11.2 API 回傳錯誤處理

**問題**：不同 HTTP Status Code 的處理方式？

**待確認**：

- 401 Unauthorized：跳轉至登入頁？
- 403 Forbidden：顯示「無權限」提示？
- 500 Server Error：顯示「系統錯誤，請稍後再試」？

**建議**：參考 ST001 的錯誤處理方式

按照建議

---

## 📝 優先級建議

### High Priority（影響 Technical Design）

1. Quick View Modal Tab 結構（影響元件設計）
2. "顯示所有敏感資料"按鈕行為（影響 API 設計）
3. 搜索欄位範圍與匹配規則（影響查詢邏輯）
4. Status 篩選選項（影響 UI 設計）

### Medium Priority（影響 UX）

5. 列表欄位顯示細節（Age、角色標籤）
6. Empty State & Loading State 設計
7. 排序功能的可排序欄位

### Low Priority（可後續優化）

8. 響應式設計（移動端支援）
9. 效能考量（虛擬滾動、快取策略）
10. 網路斷線處理

---

## 📅 下一步行動

1. **Product Owner 確認**：請 PO 針對 High Priority 問題提供決策
2. **設計師確認**：檢查 UI/UX 相關問題是否與設計稿一致
3. **技術討論**：針對搜索、排序的技術限制進行評估
4. **更新 Technical Design**：根據確認結果補完 Technical Design

---

**備註**：本文件將持續更新，直到所有問題都獲得解答。
