# ST009 - 角色指派介面 (Role Assignment Interface)

**ID**: ST-009  
**Priority**: Must Have (Core Feature)  
**Phase**: 4 - 角色與權限管理

## User Story

> **As a** 行政同工,  
> **I want to** 在會友資料中指派、移除、查看角色，並依角色篩選會友列表,  
> **So that** 我能靈活管理會友的系統權限，確保每位會友擁有正確的角色與存取範圍。

---

## Acceptance Criteria (AC)

### AC1: 會友編輯頁的角色管理區塊

1. **角色列表顯示**:
   - 在會友編輯頁（`/members/:id/edit`）顯示「角色管理」區塊
   - 顯示該會友目前擁有的所有角色（`member.roleIds`）
   - 每個角色顯示：
     - 角色名稱（如：超級管理員、牧區長）
     - 角色 Scope（如：Global、Zone、Group）
     - 移除按鈕（X icon）

2. **新增角色**:
   - 提供「+ 新增角色」按鈕
   - 點擊後顯示角色多選下拉選單（MultiSelect）
   - 下拉選單顯示所有可用角色（排除已擁有的角色）
   - 每個選項顯示：
     - 角色名稱
     - 角色 Scope（Badge）
     - 角色描述（Tooltip）
   - 選擇後立即加入到會友的角色列表

3. **移除角色**:
   - 點擊角色卡片的「X」按鈕可移除該角色
   - **防呆機制**：若移除後會友將沒有任何角色，顯示錯誤訊息：「每位會友至少需要一個角色」
   - 顯示確認對話框：「確定要移除 [角色名稱] 嗎？移除後該會友的權限將改變。」

4. **角色預覽**:
   - 點擊角色卡片可展開顯示該角色的權限詳情：
     - X 軸：功能權限列表（勾選項目）
     - Y 軸：資料範圍（Global / Zone / Group / Self）
     - Z 軸：解鎖權限列表（勾選項目）
   - 使用 Accordion 或 Dialog 顯示

5. **儲存變更**:
   - 點擊「儲存」按鈕後，呼叫 API 更新 `member.roleIds`
   - 顯示 Toast 確認訊息：「角色已更新」
   - 自動清除該會友的 UserContext 快取（若該會友目前在線上，下次操作時會重新計算權限）

---

### AC2: 會友詳情頁的角色顯示

1. **角色卡片顯示**:
   - 在會友詳情頁（`/members/:id`）顯示「角色與權限」區塊
   - 以卡片形式顯示該會友的所有角色
   - 每張卡片顯示：
     - 角色名稱
     - 角色 Scope（Badge）
     - 「查看權限」按鈕（展開顯示 XYZ 三軸）

2. **快速編輯入口**:
   - 提供「編輯角色」按鈕（需 `system:config` 權限）
   - 點擊後跳轉到會友編輯頁的角色管理區塊

---

### AC3: 會友列表的角色篩選與顯示

1. **角色欄位顯示**:
   - 在會友列表表格（`/members`）新增「角色」欄位
   - 顯示該會友的所有角色（以 Tag 或 Chip 顯示）
   - 若角色過多（> 2 個），顯示「+N」按鈕，Hover 顯示完整列表

2. **角色篩選器**:
   - 在篩選區新增「角色」多選下拉選單
   - 選擇一個或多個角色後，列表僅顯示擁有這些角色的會友
   - **篩選邏輯**（需確認）：
     - 選項 A：OR 邏輯（擁有任一選定角色即顯示）
     - 選項 B：AND 邏輯（必須同時擁有所有選定角色）
   - 目前採用：**選項 A（OR 邏輯）**

3. **角色統計**:
   - 在會友列表頂部顯示統計資訊：
     - 超級管理員：X 人
     - 牧區長：Y 人
     - 小組長：Z 人
     - 課程老師：W 人
   - 點擊統計數字可快速篩選該角色

---

### AC4: 角色變更後的權限即時生效

1. **清除 UserContext 快取**:
   - 當會友的 `roleIds` 更新後，系統自動清除該會友的 UserContext 快取
   - **實作方式**（需確認）：
     - 選項 A：使用 Redis 或 Memory Cache，儲存 Key = `userContext:{userId}`，變更後刪除該 Key
     - 選項 B：在 `members` Collection 新增 `contextVersion` 欄位，變更後遞增版本號，Middleware 檢查版本號
   - 目前採用：**選項 A（Redis Cache）**

2. **強制重新登入（選填）**:
   - 若角色變更涉及重大權限調整（如移除管理員角色），可選擇「強制該會友重新登入」
   - 顯示 Checkbox：「變更後立即強制重新登入」
   - 若勾選，系統會清除該會友的所有 Token（由 ST010 實作）

---

### AC5: 批次角色指派（選填，可後續迭代）

1. **批次選擇會友**:
   - 在會友列表勾選多位會友（Checkbox）
   - 點擊「批次指派角色」按鈕

2. **批次指派對話框**:
   - **標題**：批次指派角色（已選擇 X 位會友）
   - **內容**：
     - 已選擇的會友列表（顯示姓名與當前角色）
     - 角色多選下拉選單
     - 指派模式選擇：
       - 「新增角色」（保留原有角色，追加新角色）
       - 「取代角色」（移除所有原有角色，僅保留選定角色）
   - **按鈕**：
     - 取消 (outlined)
     - 確定指派 (severity="primary")

3. **批次指派邏輯**:
   - 點擊「確定指派」後，呼叫 API 批次更新會友的 `roleIds`
   - 顯示 Toast 確認訊息：「已為 X 位會友指派角色」
   - 自動清除所有相關會友的 UserContext 快取

---

### AC6: 權限控制 (RBAC)

1. **查看角色** (member:view):
   - 所有具備 `member:view` 權限的角色皆可查看會友的角色列表

2. **指派角色** (system:config):
   - 僅具備 `system:config` 權限的角色可以新增、移除會友的角色
   - 在會友編輯頁，若無權限則隱藏「編輯角色」按鈕

3. **指派限制（選填）**:
   - **選項 A**：任何具備 `system:config` 的角色皆可指派所有角色（包含超級管理員）
   - **選項 B**：限制「僅超級管理員可指派超級管理員角色」，其他管理員僅能指派 Zone Leader 以下角色
   - 目前採用：**選項 A（無限制）**

---

## Business Rules

### BR1: 角色數量限制
- **至少一個角色**：每位會友至少需要一個角色，預設為 `general`（一般會友）
- **多重角色無上限**：同一會友可擁有任意數量的角色（實務上通常 1-3 個）

### BR2: 系統角色保護
- **系統角色不可刪除**：5 種預設角色（`super_admin`, `zone_leader`, `group_leader`, `teacher`, `general`）設定 `isSystem: true`，不可刪除
- **移除角色前檢查**：若某角色正被會友使用，無法刪除該角色（由 ST002 負責）

### BR3: 權限計算規則
- **Union 策略**：若會友擁有多個角色，權限採 Union（任一角色有權限即有權限）
- **Scope 取最大**：若會友擁有多個角色，Scope 取最大範圍（Global > Zone > Group > Self）
- **解鎖權限合併**：若任一角色有解鎖權限，即有解鎖權限

### BR4: 角色變更生效時機
- **立即生效（下次請求）**：角色變更後，會友下次 API 請求時會重新計算 UserContext
- **無需重新登入**：角色變更不需要強制重新登入（除非管理員勾選「強制重新登入」）

### BR5: 新會友預設角色
- **預設角色**：新會友註冊時，預設指派 `general`（一般會友）角色
- **自動指派時機**：在會友建立時（ST004），API 自動寫入 `roleIds: ['general']`

---

## UI/UX Requirements

### UX1: 會友編輯頁的角色管理區塊

**Layout:**
- 位於會友編輯頁的「系統資訊」Section
- 顯示標題：「角色與權限」
- 下方顯示角色卡片列表 + 「+ 新增角色」按鈕

**角色卡片樣式:**
```
[Icon: pi-shield-check] 牧區長
  Scope: Zone [Badge: severity="warn"]
  [X 按鈕]
```

**新增角色下拉選單:**
- 使用 PrimeVue `MultiSelect` 元件
- `optionLabel="name"`
- `filter=true`（支援搜尋）
- 顯示 Scope Badge 於選項中

### UX2: 會友詳情頁的角色顯示

**角色卡片樣式:**
```
[Card]
  牧區長
  Scope: Zone
  [查看權限 按鈕]
```

**權限詳情對話框:**
- 使用 PrimeVue `Dialog` 元件
- 標題：「牧區長 - 權限詳情」
- 內容分三區：
  - 功能權限（X 軸）：列表顯示，勾選項目
  - 資料範圍（Y 軸）：Zone（僅限所屬牧區）
  - 解鎖權限（Z 軸）：列表顯示，勾選項目

### UX3: 會友列表的角色篩選

**篩選器樣式:**
- 使用 PrimeVue `MultiSelect` 元件
- Placeholder：「篩選角色」
- 顯示 Scope Badge 於選項中

**角色顯示樣式（列表欄位）:**
```
小組長 [Tag: severity="info"]
老師 [Tag: severity="success"]
+1 [Hover: 顯示完整列表]
```

### UX4: Toast 確認訊息

**成功訊息:**
```
severity: 'success'
summary: '角色已更新'
detail: '已為 [會友姓名] 更新角色'
life: 3000
```

**錯誤訊息:**
```
severity: 'error'
summary: '無法移除角色'
detail: '每位會友至少需要一個角色'
life: 5000
```

---

## Technical Considerations

### TC1: UserContext 快取清除
- **實作方式**：使用 Redis 或 Memory Cache
- **Key 格式**：`userContext:{userId}`
- **TTL**：5 分鐘（與 ST002 一致）
- **清除時機**：角色變更後立即清除

### TC2: 批次指派效能
- **限制數量**：批次指派最多 50 位會友
- **Firestore Batch Write**：使用 Batch Write 更新 `member.roleIds`
- **快取清除**：批次清除所有相關會友的 UserContext 快取

### TC3: 角色預覽資料來源
- **即時查詢**：點擊「查看權限」時，即時查詢該角色的 XYZ 三軸設定（從 `roles` Collection）
- **快取**：可考慮在前端快取角色資料（TTL: 5 分鐘）

### TC4: 錯誤處理
- **角色不存在**：若 `roleIds` 包含不存在的角色 ID，API 回傳錯誤
- **權限不足**：若無 `system:config` 權限，API 回傳 403
- **至少一個角色**：若移除後無角色，API 回傳 400

---

## Out of Scope

以下功能不在此 Story 範圍內：

- ❌ 角色 CRUD（由 ST002 負責）
- ❌ 角色權限矩陣編輯（由 ST002 負責）
- ❌ 強制重新登入（由 ST010 負責）
- ❌ 角色變更歷史記錄（預留給 ST027 審計日誌）
- ❌ 角色申請與審批流程（後續迭代）

---

## Dependencies

- ✅ **ST001**: 資料核心與 Schema 定義 (members.roleIds)
- ✅ **ST002**: RBAC Configuration (roles Collection, UserContext 解析)
- ✅ **ST004**: 會友資料 CRUD（提供會友編輯頁與詳情頁）

---

## Success Metrics

- ✅ 能夠在會友編輯頁新增、移除角色
- ✅ 能夠在會友詳情頁查看角色與權限
- ✅ 能夠在會友列表依角色篩選
- ✅ 角色變更後 UserContext 快取正確清除
- ✅ 權限控制正確套用（僅 system:config 可指派角色）
- ✅ 至少一個角色的防呆機制正常運作

---

## Related Stories

- **ST002**: RBAC Configuration（提供角色定義與權限矩陣）
- **ST004**: 會友資料 CRUD（提供會友編輯頁與詳情頁）
- **ST010**: 帳號安全與密碼管理（提供強制重新登入功能）
- **ST027**: 審計日誌（記錄角色變更歷史）
