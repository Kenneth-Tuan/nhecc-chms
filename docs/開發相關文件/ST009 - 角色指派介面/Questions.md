# ST009 - Questions & Clarifications

本文件記錄開發過程中需要澄清的問題與決策點。

---

## 🔴 Critical Questions (阻擋開發)

### Q1: UserContext 快取的實作方式

**問題描述**:  
角色變更後，需要清除該會友的 UserContext 快取，應採用哪種快取機制？

**選項**:
- A. 使用 Node Memory Cache（node-cache 套件）
- B. 使用 Redis（需額外架設 Redis Server）
- C. 在 `members` Collection 新增 `contextVersion` 欄位，Middleware 檢查版本號
- D. 不使用快取，每次請求都重新計算 UserContext

**採用方案**: A（Node Memory Cache）

**原因**:
- 實作簡單，不需額外架設 Redis
- 適合中小型教會（會友數量 < 10,000）
- 若未來需要擴展，可改用 Redis

**影響範圍**: 
- `server/utils/cache.ts` 的實作
- `server/middleware/02.rbac.ts` 的快取邏輯

---

### Q2: 角色篩選的邏輯

**問題描述**:  
在會友列表使用角色篩選時，應採用 OR 邏輯還是 AND 邏輯？

**選項**:
- A. OR 邏輯（擁有任一選定角色即顯示）
- B. AND 邏輯（必須同時擁有所有選定角色）
- C. 提供切換按鈕，讓使用者選擇

**範例說明**:
- 若使用者選擇「小組長」和「老師」兩個角色：
  - OR 邏輯：顯示所有是小組長「或」是老師的會友
  - AND 邏輯：顯示同時是小組長「且」是老師的會友

**採用方案**: A（OR 邏輯）

**原因**:
- 符合一般使用者預期（「找出所有小組長和老師」）
- 實作簡單（Firebase 使用 `array-contains-any`）

**影響範圍**: 
- `member.repository.ts` 的 `findAll` 方法
- 會友列表頁的篩選邏輯

---

### Q3: 至少一個角色的防呆位置

**問題描述**:  
「至少一個角色」的防呆檢查應在前端還是後端？

**選項**:
- A. 僅在前端檢查（前端禁用「移除」按鈕）
- B. 僅在後端檢查（API 回傳錯誤）
- C. 前後端雙重檢查（推薦）

**採用方案**: C（前後端雙重檢查）

**原因**:
- 前端提供即時反饋（使用者體驗好）
- 後端防止 API 直接呼叫繞過前端檢查（安全性）

**影響範圍**: 
- `MemberRoleManager.vue` 的移除按鈕邏輯
- `member.service.ts` 的 `updateMemberRoles` 驗證

---

## 🟡 High Priority Questions (影響 UX)

### Q4: 角色變更後是否強制重新登入

**問題描述**:  
當會友的角色變更（尤其是權限降低）時，是否需要強制該會友重新登入？

**選項**:
- A. 不強制，下次請求時自動套用新權限（推薦）
- B. 提供 Checkbox 讓管理員選擇是否強制重新登入
- C. 權限降低時自動強制重新登入，權限提升時不強制

**採用方案**: B（提供 Checkbox 讓管理員選擇，默認為 TRUE。
  並且畫面中 Checkbox 下方提供文字提示：權限降低時需儘快重新登入以免造成blablabla 類似這樣的文字說明。）

**原因**:
- 給予管理員彈性
- 一般情況下不需強制登出（UserContext 快取 5 分鐘後自動失效）
- 重大權限調整（如移除管理員）時可選擇強制登出

**影響範圍**: 
- `MemberRoleManager.vue` 的儲存邏輯
- `/api/members/roles/assign` 的 `forceLogout` 參數處理
- 需整合 ST010 的強制登出功能

---

### Q5: 角色預覽的顯示方式

**問題描述**:  
點擊角色卡片查看權限詳情時，應使用什麼 UI 元件？

**選項**:
- A. Dialog 對話框（全螢幕遮罩）
- B. Sidebar / Drawer（側邊滑出）
- C. Accordion 手風琴（在卡片內展開）
- D. Popover 氣泡框（Hover 顯示）

**目前採用方案**: 待定

**原因**:
- 顯示資訊較多（XYZ 三軸），需要足夠空間
- 清楚的焦點切換（遮罩背景）

**影響範圍**: 
- `RolePreviewDialog.vue` 的元件選擇

---

### Q6: 批次指派的模式選擇

**問題描述**:  
批次指派角色時，應支援「新增」模式還是「取代」模式？

**選項**:
- A. 僅支援「新增」模式（保留原有角色，追加新角色）
- B. 僅支援「取代」模式（移除所有原有角色，僅保留選定角色）
- C. 同時支援兩種模式，讓使用者選擇（推薦）

**目前採用方案**: 待定

**原因**:
- 給予管理員彈性
- 新增模式：適合「為所有小組長追加課程老師角色」
- 取代模式：適合「將所有會友重設為一般會友」

**影響範圍**: 
- `BatchRoleAssignDialog.vue` 的模式選擇器
- `member.service.ts` 的 `batchUpdateMemberRoles` 邏輯

---

### Q7: 會友列表的角色顯示數量

**問題描述**:  
會友列表的「角色」欄位，若會友擁有多個角色，應顯示多少個？

**選項**:
- A. 顯示所有角色（可能導致欄位過寬）
- B. 顯示前 2 個角色 + 「+N」按鈕（推薦）
- C. 僅顯示第一個角色（主要角色）

**採用方案**: B（顯示前 2 個 + 「+N」）

**原因**:
- 平衡資訊完整度與介面簡潔度
- Hover「+N」按鈕顯示完整列表（Tooltip）

**影響範圍**: 
- 會友列表頁的角色欄位顯示邏輯

---

## 🟢 Medium Priority Questions (功能細節)

### Q8: 指派超級管理員的限制

**問題描述**:  
是否限制「僅超級管理員可指派超級管理員角色」？

**選項**:
- A. 無限制，任何具備 `system:config` 權限的角色皆可指派所有角色（包含超級管理員）
- B. 限制「僅超級管理員可指派超級管理員角色」，其他管理員僅能指派 Zone Leader 以下角色
- C. 提供系統設定，可動態調整限制規則

**採用方案**: A（無限制）

**原因**:
- 簡化實作邏輯
- 信任具備 `system:config` 權限的管理員
- 若需限制，後續可透過「自訂權限」實現

**影響範圍**: 
- `MemberRoleSelector.vue` 的角色選項過濾邏輯
- API 的權限檢查邏輯

---

### Q9: 批次指派的選擇上限

**問題描述**:  
批次指派應限制選擇多少位會友？

**選項**:
- A. 50 位（推薦）
- B. 100 位
- C. 不限制

**目前採用方案**: 待定

**原因**:
- 與 ST008 的批次分配一致
- 避免 Firestore Batch Write 超限（500 筆）
- 實務上很少需要一次指派 50 位以上會友

**影響範圍**: 
- `BatchRoleAssignDialog.vue` 的選擇邏輯
- API 的驗證邏輯

---

### Q10: 角色統計資訊的顯示位置

**問題描述**:  
會友列表頂部的角色統計資訊（如：小組長 X 人）應如何顯示？

**選項**:
- A. 在篩選區上方顯示統計卡片
- B. 在表格上方顯示統計 Chips（可點擊篩選）
- C. 不顯示統計資訊

**採用方案**: B（顯示統計 Chips，可點擊篩選）

**原因**:
- 提供快速篩選入口
- 節省空間

**影響範圍**: 
- 會友列表頁的 Layout

---

### Q11: 新會友預設角色的指派時機

**問題描述**:  
新會友註冊時，預設角色（`general`）應在何時指派？

**選項**:
- A. 在會友建立時（ST004 的 API），自動寫入 `roleIds: ['general']`
- B. 在會友註冊流程中，由前端明確傳入 `roleIds: ['general']`
- C. 在 RBAC Middleware 中，若 `roleIds` 為空則自動補上 `general`

**採用方案**: A（在會友建立時自動指派）

**原因**:
- 確保所有會友都有角色
- 實作簡單，邏輯集中

**影響範圍**: 
- `member.service.ts` 的 `createMember` 方法
- ST004 的會友建立邏輯

---

## 🔵 Low Priority Questions (錦上添花)

### Q12: 角色卡片的排序

**問題描述**:  
會友擁有多個角色時，角色卡片應如何排序？

**選項**:
- A. 按 Scope 排序（Global > Zone > Group > Self）
- B. 按角色名稱排序（A-Z）
- C. 按指派時間排序（最新在前）
- D. 不排序（按 `roleIds` 陣列順序）

**採用方案**: A（按 Scope 排序）

**原因**:
- 符合權限重要性（Scope 越大越重要）
- 視覺上清楚（超級管理員總是在前）

**影響範圍**: 
- `MemberRoleManager.vue` 的角色列表排序邏輯

---

### Q13: 角色變更的確認對話框

**問題描述**:  
移除角色時，是否需要顯示確認對話框？

**選項**:
- A. 顯示確認對話框（推薦）
- B. 不顯示確認對話框，直接移除
- C. 僅移除系統角色時顯示確認對話框

**採用方案**: A（顯示確認對話框）

**原因**:
- 防止誤操作
- 角色變更影響權限，需謹慎處理

**影響範圍**: 
- `MemberRoleManager.vue` 的移除邏輯

---

## 📝 Design Decisions (已決策)

### D1: 至少一個角色的限制

**決策**: 每位會友至少需要一個角色，預設為 `general`

**原因**:
- 確保權限系統正常運作
- 避免會友無法登入或存取系統

---

### D2: 角色權限採 Union 策略

**決策**: 會友擁有多個角色時，權限採 Union（任一角色有權限即有權限）

**原因**:
- 符合架構藍圖的設計（ST002）
- 符合「最大寬容原則」

---

### D3: 批次指派支援兩種模式

**決策**: 批次指派支援「新增」和「取代」兩種模式

**原因**:
- 給予管理員彈性
- 覆蓋不同的使用情境

---

## 📌 Notes & Assumptions

1. **角色 CRUD 已實作**: ST002 已實作角色的 CRUD 功能，此 Story 僅負責「將角色指派給會友」

2. **UserContext 快取機制**: 根據 ST002 架構藍圖，UserContext 快取 5 分鐘，角色變更後需清除快取

3. **強制重新登入**: 此功能由 ST010 提供，ST009 僅提供呼叫介面（`forceLogout` 參數）

4. **Audit Log**: 角色變更歷史記錄由 ST027 負責查詢介面，此 Story 僅實作寫入（預留）

5. **會友列表整合**: 需修改現有的會友列表頁（ST003），新增角色篩選器與角色欄位

---

**Last Updated**: 2026-02-16  
**Maintained By**: Development Team
