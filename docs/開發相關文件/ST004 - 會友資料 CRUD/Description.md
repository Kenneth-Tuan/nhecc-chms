# ST004 - 會友資料 CRUD 操作

## 📋 功能概述

本功能提供完整的會友資料管理介面，讓行政同工和牧區長能夠新增、編輯、查看與刪除會友資料。系統採用直觀的表單設計，支援頭像上傳、牧區小組連動選擇，以及嚴格的資料驗證機制，確保資料的正確性與一致性。

---

## 🎯 使用者故事

**As a** 行政同工或牧區長  
**I want to** 新增、編輯、刪除會友資料  
**So that** 系統能維護最新且正確的會友資訊，以支援各種牧養與管理功能

---

## ✨ 核心功能

### 1. 新增會友 (Create)

#### 功能描述
提供完整的會友資料建立表單，包含基本資訊、聯絡方式、緊急聯絡人、信仰背景等資料。

#### 主要特點
- 📸 **頭像上傳**：支援 JPG/PNG 格式，上限 2MB
- 🔗 **牧區小組連動**：選擇牧區後自動載入該牧區下的小組選項
- ✅ **即時驗證**：手機號碼、Email 格式檢查，手機號碼唯一性驗證
- 👥 **角色指派**：可於建立時直接指派會友角色（小組長、課程老師等）
- 📚 **課程紀錄**：可記錄會友已上過的福音課程

#### 表單區塊
1. **基本資訊**：頭像、姓名、性別、出生年月日
2. **聯絡資訊**：手機、Email、Line ID、地址（敏感個資）
3. **緊急聯絡人**：姓名、關係、電話（敏感個資）
4. **信仰與歸屬**：受洗狀態、受洗日期、牧區、小組、角色、已上課程
5. **系統設定**：會籍狀態（Active/Inactive/Suspended）

#### 驗證規則
- **必填欄位**：姓名、性別、出生日期、手機、Email、緊急聯絡人資訊
- **格式驗證**：手機號碼 `09XXXXXXXX`（10 碼）、Email 標準格式
- **唯一性檢查**：手機號碼不可重複
- **連動驗證**：選擇小組時必須先選擇牧區
- **日期驗證**：出生日期與受洗日期不可為未來日期

#### 操作流程
1. 點擊「新增會友」按鈕進入表單頁
2. 填寫會友資訊（必填欄位標記紅色星號）
3. （選填）上傳會友大頭貼
4. （選填）選擇牧區與小組
5. （選填）指派會友角色
6. （選填）記錄已上過的課程
7. 提交表單 → 系統驗證 → 建立成功 → 導向會友詳情頁

---

### 2. 編輯會友 (Update)

#### 功能描述
允許修改現有會友的所有資料，包含更換或移除頭像。

#### 主要特點
- 📝 **表單預填**：自動載入會友現有資料
- 🖼️ **頭像管理**：可更換或移除現有頭像
- 🔄 **樂觀更新**：編輯成功後立即更新列表快取，無需重新載入
- 🔐 **權限控制**：僅能編輯管轄範圍內的會友（Data Scope）

#### 編輯入口
- 會友列表頁的「編輯」按鈕
- 會友詳情頁的「編輯」按鈕
- Quick View Modal 的「編輯」按鈕

#### 特殊處理
- **頭像更換**：上傳新頭像時，系統自動刪除舊頭像（節省 Storage 空間）
- **牧區清空**：清空牧區時自動清空小組（保持資料一致性）
- **資料不一致警告**：若牧區與小組不匹配，系統顯示警告訊息

---

### 3. 刪除會友 (Soft Delete)

#### 功能描述
採用「軟刪除」機制，將會友狀態標記為 `Inactive`，保留歷史記錄而不實際刪除資料。

#### 主要特點
- 🗑️ **軟刪除設計**：資料不會被實際刪除，僅標記為停用
- 📝 **刪除原因記錄**：必須選擇刪除原因（離開教會、遷移、重複建檔等）
- 📊 **審計追蹤**：完整記錄刪除操作至審計日誌
- ↩️ **可復原**：可透過「編輯」功能將狀態改回 `Active`

#### 刪除原因選項
- 離開教會
- 遷移至其他教會
- 重複建檔
- 資料錯誤
- 其他原因（需填寫備註說明）

#### 刪除流程
1. 點擊「刪除」按鈕
2. 彈出確認對話框，顯示會友姓名
3. **必須選擇刪除原因**
4. （選填）若選擇「其他原因」，可填寫備註說明
5. 確認刪除 → 狀態改為 `Inactive` → 記錄審計日誌 → 導向會友列表

#### 刪除權限
- 需要 `member:delete` 權限
- 僅能刪除管轄範圍內的會友（Data Scope 檢查）

---

### 4. 會友詳情頁 (Detail View)

#### 功能描述
完整顯示會友的所有資訊，採用 Tab 分頁設計，方便瀏覽不同類別的資料。

#### 頁面佈局
- **Header**：會友姓名、快速操作按鈕（編輯、刪除）
- **Tab 1 - 基本資料**：顯示會友的基本資訊、聯絡方式、緊急聯絡人、教會資訊
- **Tab 2 - 課程紀錄**：顯示會友的課程修習歷史

#### 敏感資料顯示
- 預設遮罩：手機、Email、地址、Line ID、緊急聯絡人電話
- 可透過「顯示」按鈕解鎖單一欄位（需權限）
- 可透過「顯示所有敏感資料」按鈕一次解鎖所有欄位（需權限）

---

## 🔐 權限要求

### 功能權限

| 功能 | 權限 | 說明 |
|------|------|------|
| 新增會友 | `member:create` | 可建立新會友資料 |
| 編輯會友 | `member:edit` | 可修改會友資料 |
| 刪除會友 | `member:delete` | 可標記會友為停用 |
| 查看詳情 | 符合 Data Scope | 可查看管轄範圍內的會友 |

### Data Scope 限制

系統會根據使用者的 Data Scope 限制可操作的會友範圍：

- **Global**：可操作所有會友
- **Zone**：僅可操作所屬牧區的會友
- **Group**：僅可操作所屬小組的會友
- **Self**：僅可操作自己的資料

---

## 🎨 使用者介面

### 表單設計原則
- ✅ **清晰的區塊分隔**：使用 Divider 分隔不同類別的資料
- ✅ **必填欄位標示**：紅色星號標記必填欄位
- ✅ **即時錯誤提示**：欄位下方顯示紅色錯誤訊息
- ✅ **禁用狀態提示**：未選牧區時，小組下拉選單顯示「請先選擇牧區」
- ✅ **Loading 狀態**：表單提交中顯示 Loading 動畫，防止重複提交

### 錯誤處理
- **前端驗證失敗**：欄位下方顯示紅色錯誤訊息
- **後端驗證失敗**：Toast 通知 + 欄位錯誤訊息
- **網路錯誤**：Toast 通知：「無法連線至伺服器，請稍後再試」

### 成功回饋
- **新增成功**：Toast 通知「會友新增成功！」→ 導向詳情頁
- **編輯成功**：Toast 通知「會友資料已更新！」→ 導向詳情頁
- **刪除成功**：Toast 通知「會友資料已標記為停用」→ 導向列表頁

---

## 📊 資料管理

### 頭像存儲策略

#### 上傳規則
- **格式限制**：JPG、PNG
- **大小上限**：2MB
- **建議尺寸**：300x300px
- **存儲路徑**：`avatars/{memberUuid}/{timestamp}_{filename}`

#### 清理機制
為避免 Firebase Storage 佔用過多空間，系統實作了自動清理機制：

1. **即時清理**：更換頭像時自動刪除舊檔案
2. **定期清理**：每週日凌晨 2:00 自動執行批次清理
   - 掃描所有頭像檔案
   - 刪除未被任何會友引用且超過 7 天的檔案
   - 記錄清理結果至系統日誌
3. **手動清理**：提供管理員手動觸發清理任務的介面

### 牧區小組連動

#### 連動邏輯
- 選擇牧區後，小組下拉選單僅顯示該牧區下的小組
- 未選牧區時，小組下拉選單為 disabled 狀態
- 切換牧區時，自動清空已選擇的小組
- 選擇小組時，系統檢查牧區是否已選（Zod refinement）

#### 待分發狀態
- 允許 `zoneId` 有值而 `groupId` 為 null（已分配牧區但尚未分配小組）
- 列表頁顯示橘色「待分發」Badge

---

## 🔍 資料驗證

### 前端驗證（即時）
- **手機號碼**：失焦時驗證格式與唯一性
- **Email**：失焦時驗證格式，顯示「建議」提示（非唯一性警告）
- **出生年月日**：選擇後立即驗證是否為未來日期

### 後端驗證（提交時）
- **Zod Schema 驗證**：完整檢查所有欄位格式與規則
- **業務邏輯驗證**：
  - 手機號碼唯一性（強制）
  - 牧區小組連動關係
  - 權限與 Data Scope 檢查
- **錯誤訊息**：返回標準格式的錯誤訊息，前端解析並顯示於對應欄位

---

## 📝 審計日誌

所有 CRUD 操作皆會記錄至 `audit_logs` collection：

| 操作 | 記錄內容 |
|------|---------|
| 新增會友 | 操作者、會友姓名、手機號碼、建立時間 |
| 編輯會友 | 操作者、會友姓名、變更欄位列表、更新時間 |
| 刪除會友 | 操作者、會友姓名、原始狀態、刪除原因、刪除時間 |

---

## 🔄 與其他功能的整合

### ST001 - 資料核心與 Schema 定義
- 復用 `Member` Schema 與 Type Definitions
- 使用 Zod Schema 進行表單驗證

### ST002 - RBAC Configuration
- 整合權限檢查（member:create, member:edit, member:delete）
- 套用 Data Scope 過濾（Global/Zone/Group/Self）

### ST003 - 會友資料列表
- 列表頁作為 CRUD 操作的入口
- 編輯成功後樂觀更新列表快取

### ST005 - 敏感資料解鎖機制
- 詳情頁使用敏感資料遮罩與解鎖功能
- 表單編輯時完整顯示敏感資料（不遮罩）

---

## 🎯 使用場景範例

### 場景 1：行政同工新增會友
1. 新會友來到教會，填寫紙本資料表
2. 行政同工登入系統，點擊「新增會友」
3. 依序填寫會友的基本資料、聯絡方式、緊急聯絡人
4. 上傳會友提供的大頭貼
5. 選擇牧區為「青年牧區」，小組為「大學小組 A」
6. 勾選「已受洗」，填寫受洗日期
7. 記錄會友已上過「幸福小組」課程
8. 提交表單，系統驗證通過，會友資料建立成功

### 場景 2：牧區長更新會友資料
1. 會友換了新手機號碼，通知牧區長更新
2. 牧區長在會友列表中搜尋該會友
3. 點擊「編輯」按鈕進入編輯頁
4. 更新手機號碼欄位
5. 系統驗證新手機號碼格式與唯一性
6. 儲存變更，系統記錄「手機號碼已更新」至審計日誌

### 場景 3：會友遷移至其他教會
1. 會友通知要遷移至其他城市的教會
2. 牧區長在會友詳情頁點擊「刪除」
3. 系統彈出確認對話框
4. 選擇刪除原因：「遷移至其他教會」
5. 填寫備註：「搬遷至台中，已介紹至台中某教會」
6. 確認刪除，系統將會友狀態改為 `Inactive`
7. 會友資料保留於系統中，但不再出現於預設列表
8. 審計日誌記錄完整的刪除原因與備註

### 場景 4：會友角色異動
1. 小組長任期屆滿，需要更新角色
2. 行政同工開啟會友編輯頁
3. 在「角色」欄位中，移除「小組長」角色
4. 新增「課程老師」角色
5. 儲存變更，系統更新會友的 `roleIds` 欄位
6. 會友列表自動更新角色標籤顯示

---

## 📈 效能優化

### 資料快取
- **組織架構（牧區與小組）**：Pinia Store 快取 10 分鐘
- **角色清單**：Pinia Store 快取 30 分鐘
- **課程清單**：Pinia Store 快取 30 分鐘

### 樂觀更新
- 編輯成功後立即更新 Pinia Store 中的列表資料
- 避免重新呼叫列表 API，減少 Loading 時間

### 頭像上傳
- 使用 Firebase Storage 的 `getDownloadURL()` 自動產生帶 Token 的 URL
- 避免瀏覽器快取問題
- 定期清理未使用的頭像檔案，節省 Storage 空間

---

## ⚠️ 注意事項

### 軟刪除設計
- 刪除會友並不會實際移除資料，僅將 `status` 改為 `Inactive`
- 審計日誌仍可追溯刪除操作
- 管理員可透過編輯功能將狀態改回 `Active`（復原）

### 手機號碼唯一性
- 手機號碼為會友的唯一識別碼，不可重複
- 建立與編輯時都會進行唯一性檢查
- 若手機號碼重複，系統顯示錯誤：「此手機號碼已被使用」

### Email 非唯一性
- Email 為必填但允許重複（考量家庭成員可能共用 Email）
- 失焦時若發現重複，顯示「建議」提示而非錯誤

### 牧區小組連動
- 選擇小組時必須先選擇牧區（Zod refinement）
- 清空牧區時自動清空小組（保持資料一致性）
- 若資料庫中存在牧區小組不匹配的情況，載入表單時顯示警告訊息

### 權限與 Data Scope
- 僅能編輯與刪除管轄範圍內的會友
- 超出範圍時系統返回 403 Forbidden
- 前端隱藏無權限的操作按鈕，後端強制檢查

---

## 🚀 未來擴充

1. **批次匯入**：支援 Excel/CSV 批次匯入會友資料
2. **欄位歷史記錄**：記錄每個欄位的變更歷史（Who、When、What）
3. **重複資料偵測**：建立時自動偵測可能的重複資料（模糊比對姓名、手機）
4. **頭像裁切**：上傳頭像時提供線上裁切功能
5. **會友標籤**：支援自訂標籤（新朋友、穩定聚會、需要關懷等）

---

**Document Version**: 1.0  
**Last Updated**: 2025-02-11  
**Status**: ✅ Ready for Implementation
