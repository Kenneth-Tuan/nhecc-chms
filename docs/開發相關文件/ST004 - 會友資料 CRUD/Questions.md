# ST004 - Questions & Clarifications

## 待澄清問題

### 1. 頭像存儲策略

**問題 1.1**: 若會友被軟刪除（`status = Inactive`），頭像檔案是否需要保留？

- **選項 A**: 保留頭像檔案（即使 status = Inactive，歷史記錄仍可顯示頭像）
- **選項 B**: 立即刪除頭像檔案（節省 Storage 空間）
- **建議**: 選項 A（保留檔案，避免歷史記錄遺失）

選 A

**問題 1.2**: 頭像檔案的命名規則？

- **當前設計**: `avatars/{memberUuid}/{timestamp}_{originalFilename}`
- **潛在問題**: 編輯時更換頭像，舊檔案是否需要刪除？
- **建議**:
  - 新增頭像時，刪除該會友的舊頭像檔案
  - 避免單一會友佔用過多 Storage

按照建議

**問題 1.3**: 頭像 URL 是否需要加上版本號或 Timestamp 避免瀏覽器快取？

- **範例**: `https://storage.googleapis.com/.../avatar.jpg?v=1234567890`
- **建議**: 使用 Firebase Storage 的 `getDownloadURL()` 自動產生帶 Token 的 URL

按照建議

---

### 2. Email 唯一性

**問題 2.1**: Email 欄位是否需要強制唯一性檢查？

- **當前設計**:
  - `mobile` 為強制唯一（必填）
  - `email` 為必填，但尚未要求唯一
- **考量**:
  - 優點：避免重複資料，防止同一人重複建立
  - 缺點：家庭成員可能共用 Email
- **建議**:
  - **必填但非唯一**（允許重複）
  - 僅在失焦時顯示「建議」提示：「此 Email 已被使用，請確認是否為不同會友」

按照建議

---

### 3. 軟刪除後的資料存取

**問題 3.1**: `status = Inactive` 的會友是否還能在列表中被搜尋到？

- **選項 A**: 預設隱藏 Inactive 會友，但提供「包含已停用」篩選器
- **選項 B**: 完全不顯示 Inactive 會友（僅管理員可透過特殊介面查看）
- **建議**: 選項 A（提供篩選器，方便管理員查詢歷史資料）

按照建議

**問題 3.2**: 是否需要「復原」功能（將 Inactive 改回 Active）？

- **實作方式**: 透過「編輯會友」功能，手動將 `status` 改回 `Active`
- **建議**: 不需要專門的「復原」按鈕，透過編輯功能即可

按照建議

**問題 3.3**: Soft Delete 是否需要記錄「刪除原因」？

- **範例**: 離開教會、遷移至其他教會、重複建檔等
- **建議**:
  - Phase 2 不實作（簡化流程）
  - 未來可擴充 `deletionReason` 欄位

請直接擴充 deletionReason 欄位，這個資料很重要

---

### 4. 牧區小組連動的邊界情況

**問題 4.1**: 若會友原本有 `groupId`，編輯時清空 `zoneId`，系統應該如何處理？

- **選項 A**: 自動清空 `groupId`（保持資料一致性）
- **選項 B**: 顯示錯誤：「請先清空小組，才能清空牧區」
- **建議**: 選項 A（自動清空，使用者體驗較佳）

按照建議

**問題 4.2**: 若會友的 `zoneId` 與 `groupId` 不匹配（資料錯誤），編輯時如何處理？

- **情境**: 資料庫中存在 `zoneId = A, groupId = B`，但 B 小組不屬於 A 牧區
- **建議**:
  - 載入表單時顯示警告訊息
  - 強制使用者重新選擇牧區與小組

按照建議

**問題 4.3**: 「待分發」會友（`groupId = null`）是否可以有 `zoneId`？

- **情境**: 已分配牧區，但尚未分配小組
- **建議**: **允許**（`zoneId` 有值，`groupId` 為 null 是合法的）

按照建議

---

### 5. 課程紀錄 (pastCourses)

**問題 5.1**: 在 Create/Edit 表單中，`pastCourses` 欄位的定位？

- **選項 A**: 僅顯示在表單中，作為初始資料（MultiSelect 選擇）
- **選項 B**: 在表單中隱藏，僅在詳情頁 Tab 2（課程紀錄）中管理
- **當前設計**: 選項 A（表單中顯示，允許建立時填寫歷史課程）

按當前設計

**問題 5.2**: `pastCourses` 與 Tab 2 的「課程紀錄」關係？

- **`pastCourses`**: 簡單的字串陣列 `['course-1', 'course-2']`
- **課程紀錄**: 包含完成狀態、日期等詳細資訊（`MemberCourseRecord[]`）
- **建議**:
  - Create/Edit 表單：僅提供 `pastCourses`（歷史課程 ID 列表）
  - 詳情頁 Tab 2：顯示完整的課程紀錄，並可新增/編輯

按照建議

**問題 5.3**: 是否需要在 Create/Edit 時驗證 `pastCourses` 的有效性？

- **驗證內容**: 檢查 Course ID 是否存在於 `courses` collection
- **建議**: 前端透過 MultiSelect 限制選項，後端不強制驗證（允許歷史課程 ID）

按照建議

---

### 6. 角色指派 (roleIds)

**問題 6.1**: 新增/編輯會友時，是否需要直接指派角色？

- **當前設計**: 表單中未顯示 `roleIds` 欄位
- **相關 Story**: ST009 - 角色指派介面（專門管理角色）
- **建議**:
  - Create 表單：不顯示 `roleIds`（預設為空陣列）
  - Edit 表單：不顯示 `roleIds`（透過 ST009 的專門介面管理）

都要顯示角色，欄位是一個 select 欄位，可以下拉選擇角色

**問題 6.2**: 若表單不顯示 `roleIds`，API 是否仍需支援此欄位？

- **建議**:
  - API 保留 `roleIds` 欄位（未來擴充彈性）
  - 前端表單暫不使用

---

### 7. 敏感資料遮罩

**問題 7.1**: Create/Edit 表單中的敏感欄位是否需要遮罩？

- **敏感欄位**: `mobile`, `email`, `address`, `lineId`, `emergencyContactPhone`
- **選項 A**: 完整顯示（表單輸入時不遮罩）
- **選項 B**: 編輯模式時預填遮罩值，需點擊「顯示」才能看到完整內容
- **建議**: **選項 A**（表單輸入時完整顯示，僅在列表/詳情頁遮罩）

按照建議

**問題 7.2**: 編輯模式時，若使用者無權限查看敏感資料，如何處理？

- **情境**: 使用者有 `member:edit` 權限，但無 `sensitive:mobile` 權限
- **選項 A**: 顯示遮罩值，無法編輯敏感欄位
- **選項 B**: 完全隱藏敏感欄位
- **選項 C**: 顯示「需要權限才能編輯此欄位」提示
- **建議**: **Phase 2 不實作細粒度權限**，編輯權限即可編輯所有欄位

按照建議

---

### 8. 表單 UX 細節

**問題 8.1**: 受洗日期 (`baptismDate`) 是否應為「建議填寫」而非「選填」？

- **當前設計**: `baptismStatus = true` 時顯示 `baptismDate`，但非必填
- **建議**: 保持選填（有些會友可能不記得確切日期）

按照建議

**問題 8.2**: 緊急聯絡人的「關係」選項是否需要擴充？

- **當前選項**: 父子、母女、父女、母子、配偶、朋友、其他
- **建議**: 新增「兄弟姊妹」、「子女」選項

按照建議

**問題 8.3**: 新增成功後的導向行為？

- **選項 A**: 導向會友詳情頁（`/dashboard/members/{uuid}`）
- **選項 B**: 導向會友列表頁，並高亮新建立的會友
- **選項 C**: 顯示成功訊息，停留在表單頁，詢問是否繼續新增
- **當前設計**: 選項 A
- **建議**: 保持選項 A（最直觀）

按照建議

---

### 9. 效能與資料載入

**問題 9.1**: 牧區與小組資料的快取策略？

- **情境**: 每次載入表單都需要呼叫 `/api/organization/structure`
- **建議**:
  - 使用 Pinia Store 快取組織架構資料
  - 快取有效期：10 分鐘（或手動刷新）

按照建議

**問題 9.2**: 課程清單的快取策略？

- **情境**: 課程清單變動頻率較低
- **建議**:
  - 使用 Pinia Store 快取 `courses` 資料
  - 快取有效期：30 分鐘

按照建議

---

### 10. 錯誤處理細節

**問題 10.1**: 若 Firebase Storage 上傳失敗，是否允許繼續建立會友（不含頭像）？

- **選項 A**: 上傳失敗則整個表單提交失敗
- **選項 B**: 顯示警告，允許使用者選擇是否繼續（不含頭像）
- **建議**: **選項 A**（上傳失敗則整個表單提交失敗，避免資料不一致）

按照建議

**問題 10.2**: 若後端驗證失敗，前端如何顯示錯誤？

- **情境**: 後端返回多個欄位錯誤
- **建議**:
  - 解析 `errors[]` 陣列，將錯誤訊息對應至表單欄位
  - 同時顯示 Toast 通知：「表單驗證失敗，請檢查紅色標記的欄位」

按照建議

---

## 決策記錄

### ✅ 已確認決策

1. **軟刪除機制**: 使用 `status = Inactive` 標記刪除，不實際刪除資料
2. **牧區小組連動**: 選擇小組時必須先選擇牧區（Zod refinement）
3. **手機號碼唯一性**: 強制檢查，建立/編輯時都需驗證
4. **頭像上傳**: 使用 Firebase Storage，路徑格式為 `avatars/{memberUuid}/{timestamp}_{filename}`
5. **表單模式**: Create 與 Edit 共用 `MemberForm` 元件，透過 `props.member` 判斷模式

### 🔄 待確認決策

1. Email 唯一性檢查
2. 軟刪除會友的列表顯示邏輯
3. 清空牧區時是否自動清空小組
4. 緊急聯絡人關係選項
5. 新增成功後的導向行為

---

## 技術風險評估

### 🔴 High Risk

- **Firebase Storage 配額**: 若會友數量龐大，頭像檔案可能佔用大量空間
  - **緩解措施**: 設定檔案大小上限（2MB）、定期清理未使用的舊檔案
    請增加該措施

### 🟡 Medium Risk

- **牧區小組連動邏輯**: 複雜的邊界情況可能導致 UX 問題
  - **緩解措施**: 詳細的錯誤提示、自動清空機制

### 🟢 Low Risk

- **表單驗證**: Zod Schema 已完善，風險較低
- **CRUD 操作**: 標準的 Firestore 操作，技術成熟

---

**Last Updated**: 2025-02-11  
**Status**: ✅ Ready for Review
