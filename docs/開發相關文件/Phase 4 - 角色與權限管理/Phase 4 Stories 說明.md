# Phase 4: 角色與權限管理 - Stories 說明

**Phase 目標**: 完善角色指派與帳號管理  
**Stories**: ST009（角色指派介面）、ST010（帳號安全與密碼管理）

---

## 一、ST009 - 角色指派介面

### 一句話說明
> 讓行政同工能在會友資料中「為會友指派一個或多個角色」，並在列表上依角色篩選會友。

### 為什麼需要這個 Story？

- **ST001** 已定義會友有 `roleIds: string[]`（支援多重角色）。
- **ST002** 已實作「角色定義」與 RBAC（角色 CRUD、權限矩陣、UserContext 解析）。
- 目前缺少的是：**把「角色」實際掛到「會友」身上的操作介面**。

也就是說：  
系統已經有「超級管理員、牧區長、小組長、老師、一般會友」等角色定義，但還沒有介面讓管理員去**指定「張三 = 小組長」「李四 = 牧區長 + 老師」**。ST009 就是在補這塊。

### 核心功能（預期）

| 功能 | 說明 |
|------|------|
| **會友詳情／編輯頁的角色指派** | 在會友編輯頁（或詳情頁）可勾選／多選「角色」，儲存後寫入 `member.roleIds`。 |
| **會友列表的角色篩選** | 在會友列表可依「擁有哪些角色」篩選（例如：只看小組長、只看老師）。 |
| **會友列表的角色顯示** | 列表上可顯示該會友擁有的角色標籤（如：小組長、老師）。 |
| **多重角色** | 同一會友可擁有多個角色（例如：牧區長 + 老師），權限採 Union 合併（架構藍圖已定義）。 |
| **權限控制** | 僅具備 `system:config`（或等同「角色／權限管理」）權限者能指派角色；必要時可再細分「僅能指派部分角色」。 |

### 與其他 Story 的關係

- **依賴**  
  - **ST001**：會友 Schema 有 `roleIds`。  
  - **ST002**：角色已定義、權限已解析（UserContext）。  
  - **ST004**：會友 CRUD 與編輯頁已存在，角色指派通常是「在會友編輯／詳情頁加一區塊」或「列表欄位＋篩選」。

- **被誰用**  
  - 之後所有依「角色」決定選單、權限、資料範圍的功能（儀表板、組織架構、課程等）都會用到「會友身上實際掛了哪些角色」，所以 ST009 是 Phase 4 的 Must Have。

### 典型使用情境

1. 新會友註冊後，預設為「一般會友」；管理員在會友編輯頁將他改為「小組長」。
2. 某同工同時擔任小組長與課程老師，管理員為他勾選「小組長」＋「課程老師」。
3. 在會友列表篩選「角色 = 牧區長」，檢視所有牧區長並檢查聯絡方式或牧區分配。

### 小結

- **ST009 = 「把角色掛到會友身上」的介面與邏輯**  
- 實作重點：會友編輯／詳情頁的「角色多選」、列表的「角色顯示＋篩選」、API 更新 `member.roleIds`，並遵守 RBAC（誰可以指派哪些角色）。

---

## 二、ST010 - 帳號安全與密碼管理

### 一句話說明
> 讓管理員能為會友「重設密碼」（發送重設連結或手動設定）以及「強制登出」，提升帳號安全與異常處理能力。

### 為什麼需要這個 Story？

- 系統已有登入／Token（ST002 相關），但若會友**忘記密碼**或**帳號異常**（例如離職、遺失裝置），需要管理端有手段處理。
- 架構藍圖在「系統與權限模組」已明確列出：  
  **帳號安全**：重設密碼（發送連結／手動設定）、強制登出。

### 核心功能（預期）

| 功能 | 說明 |
|------|------|
| **重設密碼** | 管理員可針對某會友觸發「重設密碼」：<br>• **方式 A**：系統發送重設連結（Email／簡訊），會友點連結後自行設定新密碼。<br>• **方式 B**：管理員在後台直接設定一組暫時密碼（或一次性密碼），再通知會友登入後自行更改。 |
| **強制登出** | 管理員可將某會友的現有登入階段失效（例如使該會友的 Token 失效），會友下次操作時需重新登入。用於：遺失裝置、離職、權限收回等情境。 |
| **權限控制** | 僅具備系統管理權限（如 `system:config` 或專屬的「帳號安全」權限）者能執行重設密碼與強制登出。 |
| **安全與審計** | 重設密碼、強制登出應記錄操作者、對象、時間（為日後 ST027 審計日誌鋪路）。 |

### 與其他 Story 的關係

- **依賴**  
  - **ST001**：會友資料（至少要有可辨識的帳號／Email 或手機）。  
  - **ST002**：登入機制、Token、權限（誰可以執行帳號安全操作）。

- **與登入／註冊的關係**  
  - 若目前登入是「帳密」或「Magic Link」，重設密碼會與現有 Auth 流程整合（例如呼叫 Firebase Auth 的 password reset，或自建 Token 重設流程）。  
  - ST010 不一定要實作「會友自助忘記密碼」（可放在本 Story 或另開 Story），但**管理端**的重設與強制登出是明確範圍。

### 典型使用情境

1. 會友忘記密碼，聯絡行政同工；管理員在後台點「重設密碼」並選擇「發送重設連結至 Email」，會友收信後點連結設定新密碼。
2. 小組長離職，管理員先「強制登出」該帳號，再視需要移除或調整角色（ST009）。
3. 發現某帳號在異常裝置登入，管理員執行「強制登出」並通知會友更改密碼。

### 小結

- **ST010 = 管理端的「重設密碼」＋「強制登出」**  
- 實作重點：後台操作介面（例如在會友詳情／列表的動作選單）、與現有 Auth 的整合、權限控管與操作紀錄。

---

## 三、Phase 4 兩則 Story 的對照

| 項目 | ST009 - 角色指派介面 | ST010 - 帳號安全與密碼管理 |
|------|----------------------|-----------------------------|
| **優先級** | Must Have | Should Have |
| **主要使用者** | 行政同工／管理員 | 行政同工／管理員 |
| **核心產出** | 會友的「角色」可被指派與篩選 | 會友的「密碼重設」與「強制登出」 |
| **依賴** | ST001, ST002, **ST004** | ST001, ST002 |
| **資料焦點** | `member.roleIds`、角色列表與篩選 | 密碼重設流程、Token／Session 失效 |
| **權限** | 角色／權限管理（如 `system:config`） | 帳號安全（可同屬系統管理權限） |

- **建議開發順序**：先做 **ST009**（角色指派），再做 **ST010**（帳號安全）。  
  - 角色指派會直接影響後續所有依角色顯示的介面；  
  - 帳號安全可獨立於角色指派，但實務上常與「收回權限」一起使用（先強制登出再改角色）。

---

## 四、與現有實作的對應

- **ST002** 已實作：  
  - 角色 CRUD（`/api/roles`）、角色列表頁（`dashboard/roles/index.vue`）。  
  - 權限矩陣、UserContext、RBAC Middleware。

- **ST009** 要補的是：  
  - 在「會友」維度操作角色：會友編輯／詳情頁的「角色多選」、列表的「角色欄位＋篩選」、API 更新 `member.roleIds`。

- **ST010** 要補的是：  
  - 在會友維度操作「重設密碼」與「強制登出」的 UI 與 API，並與現有登入／Token 機制整合。

若你接下來要寫 ST009 / ST010 的 Description 或 Technical Design，我可以依這份說明幫你展開成完整 AC 與技術規格。
