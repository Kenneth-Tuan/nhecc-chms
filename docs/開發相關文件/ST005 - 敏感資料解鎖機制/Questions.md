# ST005 - 敏感資料解鎖機制 - 待澄清問題

**Last Updated**: 2026-02-11

---

## 1. 審計日誌 (Audit Log) 相關

### Q1.1: 審計日誌的保留期限？

**問題**：`audit_logs` Collection 會隨時間累積，需要明確的保留策略。

**選項**：

- **Option A**: 保留最近 1 年，超過 1 年自動刪除
- **Option B**: 保留最近 1 年，超過 1 年轉存至 BigQuery（供長期分析）
- **Option C**: 永久保留（需要定期 Archive）

**建議**：Option B（平衡合規性與儲存成本）

**優先級**：Medium（可在後續 Story 處理，不阻塞本 Story 開發）

按照建議，然後將該資訊記錄到對應的 story summary 中

---

### Q1.2: 審計日誌是否需要提供查詢介面？

**問題**：目前 Description 僅描述「記錄」功能，未定義「查詢」功能。

**需澄清**：

- 是否需要提供 Admin 查詢介面（如「查看誰解鎖過 Peter 的資料」）？
- 是否需要提供使用者自查介面（如「我最近查看過哪些人的資料」）？

**影響範圍**：

- 若需要，需額外設計 API Endpoint (`GET /api/audit-logs`)
- 需額外設計 UI 介面

**建議**：不在本 Story Scope，獨立為 ST006 處理。

**優先級**：Low（MVP 可不做，Phase 3 再考慮）

按照建議，然後將該資訊記錄到對應的 story summary 中

---

### Q1.3: 審計日誌是否需要記錄失敗的解鎖嘗試？

**問題**：目前 Description 僅記錄「成功解鎖」，是否需記錄「失敗嘗試」（如無權限、Scope 限制）？

**理由**：

- **支持記錄失敗**：可追蹤潛在的越權嘗試（安全稽核）
- **反對記錄失敗**：會產生大量噪音（如使用者誤點、前端 Bug）

**建議**：僅記錄成功操作（保持 Log 乾淨），除非未來有資安稽核需求再擴充。

**優先級**：Low

紀錄失敗，因為前端目前不會顯示解鎖的按鈕給沒有權限的使用者，所以如果真的有失敗嘗試的話，就是非常特殊的情況

---

## 2. 批次解鎖 (Batch Reveal) 相關

### Q2.1: 批次解鎖是否需要一次性確認對話框？

**問題**：點擊「顯示所有敏感資料」按鈕後，是否需要二次確認（Confirmation Dialog）？

**選項**：

- **Option A**: 直接執行（快速但風險較高）
- **Option B**: 彈出確認對話框「您即將解鎖 {會友姓名} 的所有敏感資料，是否繼續？」

**建議**：Option A（使用者已進入詳情頁，代表有明確意圖，無需二次確認）

**優先級**：Low

按照建議

---

### Q2.2: 部分欄位解鎖失敗時的 UX？

**問題**：使用統一 API 後，若使用者請求解鎖多個欄位，但只有部分有權限，如何呈現？

**解決方案**（已在 AC2/AC3 中定義）：

- API 回傳 `revealedFields`（成功解鎖）+ `failedFields`（失敗原因）
- 前端依據 response 更新 UI：成功的顯示明碼，失敗的維持遮罩
- 若所有欄位都失敗，API 回傳 403 錯誤

**案例**：小組長點擊「顯示全部」

- 請求：`{ fields: ["*"] }` → 展開為 5 個欄位
- 回應：`revealedFields: { mobile: "..." }`，`failedFields: { email: {...}, lineId: {...}, ... }`
- 前端：僅 mobile 顯示明碼，其他維持遮罩，Toast 提示「已顯示 1 個欄位，4 個欄位無權限」

**優先級**：已解決（設計已明確）

---

## 3. 前端 UX 細節

### Q3.1: 解鎖狀態是否跨頁面保留？

**問題**：使用者在 Quick View Modal 中解鎖 mobile，關閉 Modal 後再重新開啟，是否需保留解鎖狀態？

**選項**：

- **Option A**: 重新開啟時重置為遮罩（隱私保護優先）
- **Option B**: 同一 Session 中保留解鎖狀態（便利性優先）

**建議**：Option A（符合 Privacy by Default 原則，避免背後偷窺風險）

**優先級**：High（已在 AC5 中定義為 Option A，此處僅供確認）

---

### Q3.2: 列表頁搜尋是否支援明碼搜尋？

**問題**：列表頁的 mobile 顯示遮罩（`092*-3**-6**`），但 ST-003 提到「後端仍需支援搜尋」。

**需澄清**：

- 使用者輸入 `0921-345-678` 時，是否能搜尋到遮罩顯示為 `092*-3**-6**` 的資料？
- 是否支援部分搜尋（如僅輸入 `0921` 或 `345`）？

**建議**：

- 支援完整號碼搜尋（`0921-345-678`）
- 支援末三碼搜尋（`678`）
- 不支援部分中間碼搜尋（避免暴力破解）

**優先級**：Medium（影響 ST-003 的搜尋功能實作）

目前先不支援搜尋電話號碼喔

---

### Q3.3: 眼睛 icon 的視覺設計規範？

**問題**：Description 中提到三種狀態（遮罩中、載入中、已解鎖），需要明確的視覺規範。

**需澄清**：

- 使用哪個 Icon Library（如 Heroicons, Lucide, Material Icons）？
- 已解鎖狀態的 Icon 是 `EyeSlashIcon` 還是 `EyeIcon` + 顏色變化？
- 是否需要 Tooltip 提示？

**建議**：

- 使用 Heroicons（Nuxt 3 常用）
- 遮罩中：`EyeIcon` 灰色
- 已解鎖：`EyeSlashIcon` 藍色
- Tooltip: 「點擊查看」/ 「已顯示」

**優先級**：Low（可由 Frontend 團隊自行決定，不阻塞開發）

請在 https://primevue.org/icons/#list 這裡找需要的 icon，不需要確認

---

## 4. 安全性與合規性

### Q4.1: 是否需要 Rate Limiting？

**問題**：避免惡意使用者短時間內大量解鎖資料（如爬取所有會友手機號碼）。

**建議方案**：

- 限制單一使用者每分鐘最多解鎖 60 次（平均 1 秒 1 次）
- 若超過限制，回傳 429 Too Many Requests

**優先級**：High（資安考量，建議納入本 Story）

按照建議

---

### Q4.2: 是否需要 IP 白名單機制？

**問題**：是否限制僅特定 IP 可解鎖敏感資料（如僅辦公室網路）？

**理由**：

- **支持**：避免使用者在公共場所（咖啡廳、捷運）解鎖資料
- **反對**：增加系統複雜度，且教會同工常需外出牧養

**建議**：不在 MVP Scope，可作為 Phase 3 的資安強化功能。

**優先級**：Low

按照建議，但請幫我記錄到相應的文件中，以便後續開發時不會遺漏

---

### Q4.3: 是否需要 MFA 驗證？

**問題**：解鎖敏感資料是否需要多因素驗證（如 OTP）？

**理由**：

- **支持**：提高安全性，避免帳號被盜後大量爬取資料
- **反對**：影響使用體驗，且教會同工可能不熟悉 MFA 操作

**建議**：不在 MVP Scope，可作為 Phase 3 的選配功能（由 Admin 決定是否啟用）。

**優先級**：Low

按照建議，但請幫我記錄到相應的文件中，以便後續開發時不會遺漏

---

## 5. 技術實作細節

### Q5.1: 審計日誌寫入是否需要 Transaction？

**問題**：若 Audit Log 寫入失敗，是否需要回滾整個解鎖操作？

**選項**：

- **Option A**: Transactional（All-or-Nothing，Log 失敗則 API 回傳 500）
- **Option B**: Async Write（Log 失敗不影響 API 回應，但後續補寫）

**建議**：Option B（避免 Log 寫入問題阻塞主要流程，但需監控 Log 寫入成功率）

**優先級**：Medium

按照建議

---

### Q5.2: 遮罩演算法是否需要支援國際化？

**問題**：目前遮罩格式針對台灣手機號碼（`0921-345-678`），若未來有國外會友（如 `+1-123-456-7890`），如何處理？

**建議**：暫時不考慮，待有實際需求再調整（可在 Technical Design 中註記為 Future Enhancement）。

**優先級**：Low

按照建議

---

### Q5.3: 是否需要前端快取 Reveal 結果？

**問題**：使用者在詳情頁解鎖 mobile 後，切換到其他 Tab 再回來，是否需要重新解鎖？

**選項**：

- **Option A**: 前端快取（同一頁面 Session 中保留）
- **Option B**: 每次都重新呼叫 API（更安全但較慢）

**建議**：Option A（同一頁面 Session 中快取，關閉頁面/Modal 後清除）

**優先級**：Medium（已在 AC5 中定義，此處僅供確認）

---

## 6. 優先級總結

| **優先級** | **問題編號** | **問題摘要**                       | **建議處理方式**     |
| ---------- | ------------ | ---------------------------------- | -------------------- |
| **High**   | Q3.1         | 解鎖狀態是否跨頁面保留？           | 已定義為「不保留」   |
| **High**   | Q4.1         | 是否需要 Rate Limiting？           | 建議納入本 Story     |
| **已解決** | Q2.2         | 部分欄位解鎖失敗時的 UX？          | Partial Success 設計 |
| **Medium** | Q3.2         | 列表頁搜尋是否支援明碼搜尋？       | 需與 ST-003 一併處理 |
| **Medium** | Q5.1         | 審計日誌寫入是否需要 Transaction？ | 定義為 Async Write   |
| **Medium** | Q5.3         | 是否需要前端快取 Reveal 結果？     | 定義為「同頁面快取」 |
| **Low**    | Q1.2         | 審計日誌是否需要查詢介面？         | 獨立為 ST006         |
| **Low**    | Q1.3         | 是否記錄失敗的解鎖嘗試？           | MVP 不做             |
| **Low**    | Q2.1         | 批次解鎖是否需要二次確認？         | 定義為「不需要」     |
| **Low**    | Q3.3         | 眼睛 icon 的視覺設計規範？         | 由 Frontend 自行決定 |
| **Low**    | Q4.2         | 是否需要 IP 白名單機制？           | Phase 3 考慮         |
| **Low**    | Q4.3         | 是否需要 MFA 驗證？                | Phase 3 考慮         |
| **Low**    | Q5.2         | 遮罩演算法是否支援國際化？         | Future Enhancement   |

---

## 7. 下一步行動

### 需立即決策的問題（High Priority）

1. **Q4.1 - Rate Limiting**: 確認是否納入本 Story，若是，需在 Technical Design 中定義限流策略

### 需與相關 Story 協調的問題（Medium Priority）

1. **Q3.2 - 列表頁搜尋**: 需與 ST-003 開發者確認搜尋邏輯
2. **Q5.1 - Audit Log 寫入策略**: 需在 Technical Design 中明確定義

### 可延後處理的問題（Low Priority）

1. **Q1.2 - 審計日誌查詢**: 規劃為獨立 Story (ST006 or Phase 3)
2. **Q4.2, Q4.3 - 進階資安功能**: 規劃為 Phase 3 功能
